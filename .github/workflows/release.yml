name: Auto Tag and Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹ (major/minor/patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—)'
        required: false
  # è‡ªåŠ¨è§¦å‘ - å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶
  push:
    branches:
      - main
    # å¿½ç•¥æŸäº›ç±»å‹çš„æäº¤
    paths-ignore:
      - '**.md'
      - '**.yaml'
      - '**.yml'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      # å…è®¸åˆ›å»ºæ ‡ç­¾å’Œrelease
      contents: write
      # å…è®¸è¯»å–æäº¤å†å²
      actions: read
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # æ‹‰å–å®Œæ•´å†å²ä»¥è·å–æ ‡ç­¾ä¿¡æ¯
          fetch-depth: 0
          # è®¾ç½®tokenä»¥æ¨é€æ ‡ç­¾
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: è·å–æœ€æ–°æ ‡ç­¾
        id: get_latest_tag
        run: |
          # è·å–æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼v0.0.0
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=${latest_tag}" >> $GITHUB_OUTPUT
          echo "æœ€æ–°æ ‡ç­¾: ${latest_tag}"

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: calculate_version
        run: |
          latest_tag=${{ steps.get_latest_tag.outputs.latest_tag }}
          custom_version=${{ github.event.inputs.custom_version || '' }}
          version_type=${{ github.event.inputs.version_type || 'patch' }}
          
          # å¦‚æœæä¾›äº†è‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼Œåˆ™ä½¿ç”¨å®ƒ
          if [ -n "$custom_version" ]; then
            # ç¡®ä¿ç‰ˆæœ¬å·ä»¥vå¼€å¤´
            if [[ "$custom_version" != v* ]]; then
              new_version="v$custom_version"
            else
              new_version="$custom_version"
            fi
          else
            # ä»æœ€æ–°æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·éƒ¨åˆ†ï¼ˆå»æ‰vå‰ç¼€ï¼‰
            version_num=${latest_tag#v}
            
            # è§£æä¸»ç‰ˆæœ¬ã€æ¬¡ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬
            IFS='.' read -r major minor patch <<< "$version_num"
            
            # æ ¹æ®ç‰ˆæœ¬ç±»å‹æ›´æ–°ç‰ˆæœ¬å·
            case "$version_type" in
              major)
                major=$((major + 1))
                minor=0
                patch=0
                ;;
              minor)
                minor=$((minor + 1))
                patch=0
                ;;
              patch)
                patch=$((patch + 1))
                ;;
            esac
            
            # æ„å»ºæ–°ç‰ˆæœ¬å·
            new_version="v${major}.${minor}.${patch}"
          fi
          
          echo "new_version=${new_version}" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬å·: ${new_version}"

      - name: ç”Ÿæˆå˜æ›´è®°å½•
        id: generate_changelog
        run: |
          latest_tag=${{ steps.get_latest_tag.outputs.latest_tag }}
          new_version=${{ steps.calculate_version.outputs.new_version }}
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜å˜æ›´è®°å½•
          changelog_file=$(mktemp)
          
          # æ·»åŠ ç‰ˆæœ¬æ ‡é¢˜
          echo "## ${new_version}" > "$changelog_file"
          echo "**å‘å¸ƒæ—¥æœŸ:** $(date '+%Y-%m-%d')" >> "$changelog_file"
          echo "" >> "$changelog_file"
          
          # ç”Ÿæˆå˜æ›´è®°å½•
          if [ "$latest_tag" = "v0.0.0" ]; then
            # å¦‚æœæ²¡æœ‰ä¹‹å‰çš„æ ‡ç­¾ï¼Œè·å–æ‰€æœ‰æäº¤
            echo "### é¦–æ¬¡å‘å¸ƒ" >> "$changelog_file"
            echo "" >> "$changelog_file"
            git log --pretty=format:"- %s (%h) by %an" >> "$changelog_file"
          else
            # è·å–ä¸¤æ¬¡æ ‡ç­¾ä¹‹é—´çš„æäº¤
            echo "### å˜æ›´å†…å®¹" >> "$changelog_file"
            echo "" >> "$changelog_file"
            git log "${latest_tag}..HEAD" --pretty=format:"- %s (%h) by %an" >> "$changelog_file"
          fi
          
          # å¦‚æœæ²¡æœ‰å˜æ›´è®°å½•ï¼Œæ·»åŠ é»˜è®¤ä¿¡æ¯
          if [ ! -s "$changelog_file" ] || [ "$(wc -l < "$changelog_file")" -le 3 ]; then
            echo "- è¿›è¡Œäº†ä»£ç æ›´æ–°" >> "$changelog_file"
          fi
          
          # æ·»åŠ é¡¹ç›®é“¾æ¥
          echo "" >> "$changelog_file"
          echo "[æŸ¥çœ‹å®Œæ•´å˜æ›´å†å²](https://github.com/${{ github.repository }}/commits/${new_version})" >> "$changelog_file"
          
          # è¾“å‡ºå˜æ›´è®°å½•å†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "å˜æ›´è®°å½•å†…å®¹:"
          cat "$changelog_file"
          
          # å°†å˜æ›´è®°å½•ä¿å­˜ä¸ºè¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat "$changelog_file" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm "$changelog_file"

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        id: check_tag_exists
        run: |
          new_version=${{ steps.calculate_version.outputs.new_version }}
          if git rev-parse "$new_version" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºGitæ ‡ç­¾
        id: create_tag
        if: steps.check_tag_exists.outputs.tag_exists == 'false'
        run: |
          new_version=${{ steps.calculate_version.outputs.new_version }}
          
          # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
          git tag -a "$new_version" -m "Release $new_version"
          
          # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
          git push origin "$new_version"
          
          echo "æ ‡ç­¾ $new_version å·²åˆ›å»ºå¹¶æ¨é€"

      - name: æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
        id: check_release_exists
        run: |
          new_version=${{ steps.calculate_version.outputs.new_version }}
          
          # ä½¿ç”¨GitHub APIæ£€æŸ¥Releaseæ˜¯å¦å­˜åœ¨
          if curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             "https://api.github.com/repos/${{ github.repository }}/releases/tags/$new_version" | grep -q "tag_name"; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # ä½¿ç”¨é¡¹ç›®çš„Goç‰ˆæœ¬
          check-latest: true

      - name: å®‰è£…ä¾èµ–
        run: go mod tidy

      - name: æ„å»ºå¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶
        id: build
        run: |
          new_version=${{ steps.calculate_version.outputs.new_version }}
          # åˆ›å»ºæ„å»ºè¾“å‡ºç›®å½•
          mkdir -p build_output
          
          # æ„å»ºLinuxç‰ˆæœ¬(amd64)
          echo "æ„å»ºLinux amd64ç‰ˆæœ¬..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w -X main.version=$new_version" -o build_output/image-shipper-linux-amd64 main.go
          
          # æ„å»ºLinuxç‰ˆæœ¬(arm64)
          echo "æ„å»ºLinux arm64ç‰ˆæœ¬..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -X main.version=$new_version" -o build_output/image-shipper-linux-arm64 main.go
          
          # æ„å»ºWindowsç‰ˆæœ¬
          echo "æ„å»ºWindowsç‰ˆæœ¬..."
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags "-s -w -X main.version=$new_version" -o build_output/image-shipper-windows-amd64.exe main.go
          
          # æ„å»ºmacOSç‰ˆæœ¬
          echo "æ„å»ºmacOSç‰ˆæœ¬..."
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags "-s -w -X main.version=$new_version" -o build_output/image-shipper-darwin-amd64 main.go
          
          # æ„å»ºmacOS ARM64ç‰ˆæœ¬
          echo "æ„å»ºmacOS ARM64ç‰ˆæœ¬..."
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags "-s -w -X main.version=$new_version" -o build_output/image-shipper-darwin-arm64 main.go
          
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          ls -la build_output/
          
          # è®¾ç½®è¾“å‡ºå‚æ•°
          echo "build_dir=build_output" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶
        id: create_release
        if: steps.check_release_exists.outputs.release_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.calculate_version.outputs.new_version }}
          name: Release ${{ steps.calculate_version.outputs.new_version }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.build.outputs.build_dir }}/image-shipper-linux-amd64
            ${{ steps.build.outputs.build_dir }}/image-shipper-linux-arm64
            ${{ steps.build.outputs.build_dir }}/image-shipper-windows-amd64.exe
            ${{ steps.build.outputs.build_dir }}/image-shipper-darwin-amd64
            ${{ steps.build.outputs.build_dir }}/image-shipper-darwin-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… è‡ªåŠ¨æ ‡ç­¾å’ŒReleaseåˆ›å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.calculate_version.outputs.new_version }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.calculate_version.outputs.new_version }}"

      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ è‡ªåŠ¨æ ‡ç­¾å’ŒReleaseåˆ›å»ºå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚"
          # è®¾ç½®é”™è¯¯é€€å‡ºç 
          exit 1